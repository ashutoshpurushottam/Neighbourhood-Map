var map,infoWindow=new google.maps.InfoWindow({content:""}),ViewModel=function(){"use strict";var a=this;a.restaurants=ko.observableArray([]),a.filteredRestaurants=ko.observableArray([]),a.loadMap=function(){map=new google.maps.Map(document.getElementById("map-container"),{center:{lat:37.3861,lng:-122.0839},zoom:13})},a.restaurantItems=function(){restaurants.forEach(function(b){var c=new Restaurant(b);a.restaurants.push(c),c.marker().setAnimation(google.maps.Animation.DROP)})},a.setRestaurantClicks=function(){a.restaurants().forEach(function(b){google.maps.event.addListener(b.marker(),"click",function(){a.clickRestaurantMarker(b)})})},a.clickRestaurantMarker=function(b){a.yelpRequest(b);var c='<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h4 class="modal-title" id="myModalLabel">'+b.name()+'</h4></div><div class="modal-body">'+b.address()+"<br>"+b.description()+'<div><span id="rating-text">Yelp Rating:</span><img id="rating-img"></div></div></div></div>';infoWindow.setContent(c),infoWindow.open(map,b.marker())},a.yelpRequest=function(a){var b=function(){for(var a="",b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c=0;c<20;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return a},c="http://api.yelp.com/v2/search/",d={oauth_consumer_key:yelpKeyData.consumerKey,oauth_token:yelpKeyData.token,oauth_nonce:b(),oauth_timestamp:Math.floor(Date.now()/1e3),oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb",term:a.name(),location:"Mountain View, CA",limit:1},e=oauthSignature.generate("GET",c,d,yelpKeyData.consumerSecret,yelpKeyData.tokenSecret);d.oauth_signature=e;var f={url:c,data:d,cache:!0,dataType:"jsonp",success:function(a){console.log(a),$("#rating-img").attr("src",a.businesses[0].rating_img_url)},error:function(){$("#rating-text").html("Could not retrieve ratings from Yelp.")}};$.ajax(f)},a.restaurantFilter=function(){a.filteredRestaurants([]);for(var b=a.restaurants().length,c=$("#search-string").val().toLowerCase(),d=0;d<b;d++){var e=a.restaurants()[d].name().toLowerCase(),f=a.restaurants()[d].address().toLowerCase();f=f.replace(/\s+/g,""),e.indexOf(c)>-1||f.indexOf(c)>-1?(a.filteredRestaurants.push(a.restaurants()[d]),a.restaurants()[d].marker().setMap(map)):a.restaurants()[d].marker().setMap(null)}},google.maps.event.addDomListener(window,"load",function(){a.loadMap(),a.restaurantItems(),a.setRestaurantClicks(),a.filteredRestaurants(a.restaurants())})};ko.applyBindings(new ViewModel);